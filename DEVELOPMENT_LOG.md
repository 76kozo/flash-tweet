# TweetMaster-Gemini × Ayrshare 開発ログ

## 1. プロジェクト初期化と環境構築

- **Next.jsプロジェクト作成**:
  - 既存の不完全な設定ファイルを削除。
  - `npx create-next-app` を使用し、Next.js 14 (App Router), TypeScript, Tailwind CSS, ESLint を備えたプロジェクトを再構築しました。
- **ライブラリインストール**:
  - 要件定義に基づき、`axios`, `zustand` をインストールしました。
  - UIライブラリとして `shadcn/ui` を導入し、初期設定を行いました。
- **Gemini SDKのセットアップ**:
  - 当初、要件定義書記載の `@google/genai` をインストールしましたが、型定義エラーが頻発しました。
  - 原因を調査した結果、公式のパッケージ名が `@google/generative-ai` であることが判明。パッケージを入れ替え、インポートパスを修正することで問題を解決しました。

## 2. アプリケーション構造の実装

- **状態管理 (Zustand)**:
  - GeminiとAyrshareのAPIキーを管理し、`localStorage`に永続化するためのZustandストア (`src/store/apiKeysStore.ts`) を作成しました。
  - Ayrshareの投稿数制限に対応するため、投稿履歴をタイムスタンプ付きで記録・管理するロジックも同ストアに統合しました。
- **コンポーネント設計**:
  - **`ApiKeySettings.tsx`**: APIキーを入力・保存・削除するためのUIコンポーネントを作成しました。
  - **`TweetGenerator.tsx`**: ツイートのキーワード入力、生成、プレビュー表示、投稿、予約投稿を行うメインのUIコンポーネントの骨格を作成しました。
  - **`page.tsx`**: アプリケーションのエントリーポイント。APIキーが保存されているかどうかに基づいて、`ApiKeySettings`と`TweetGenerator`の表示を動的に切り替えるロジックを実装しました。

## 3. Gemini API連携 (テキスト・画像生成)

- **APIクライアント**:
  - Geminiモデルとの通信を担うヘルパー関数群 (`src/lib/gemini.ts`) を作成しました。
- **テキスト・画像生成アーキテクチャ (プロンプト変換シールド)**:
  - 当初、単一のモデルでテキストと画像を同時に生成しようとしましたが、画像に不要な文字が描画される問題が発生しました。
  - この問題を解決するため、以下の3段階のプロセスを踏むアーキテクチャを考案・実装しました。
    1.  **テキスト生成**: `gemini-1.5-flash-latest`で日本語のツイート本文を生成。
    2.  **プロンプト"翻訳"**: 再度`gemini-1.5-flash-latest`を呼び出し、生成した日本語ツイートを、画像生成AI向けの**純粋な英語のビジュアルプロンプト**に変換。
    3.  **画像生成**: "翻訳"された汚染のないプロンプトのみを、画像生成モデル (`gemini-2.0-flash-preview-image-generation`) に渡し、高品質な画像を生成。
- **画像のみ再生成機能**:
  - 生成されたテキストを維持したまま、画像だけを新しいものに再生成する機能 (`handleRegenerateImage`) を実装しました。

## 4. Ayrshare API連携とデバッグ

- **APIクライアントの初期実装**:
  - `axios`を利用してAyrshare APIと通信するためのクライアント (`src/lib/ayrshare.ts`) を作成しました。
- **`400 Bad Request` エラーとの格闘**:
  - 画像付き投稿を試みた際に、Ayrshare APIから `400 Missing or incorrect parameters` エラーが頻発しました。
- **試行錯誤**:
  - **`multipart/form-data` での送信**: 当初、画像とテキストをリクエストに含めて同時に送信するこの形式を試みましたが、`platforms` や `mediaUrls` といったパラメーターの正しい形式を見つけられず、解決に至りませんでした。
- **最終的な解決策 (2段階JSON方式)**:
  - 根本的な原因が、APIが期待する通信方式の誤解にあると判断。ドキュメントの基本方針に立ち返り、実装を全面的に書き換えました。
    1.  **メディアアップロード**: まず、Base64形式の画像をJSONペイロードで `/media/upload` エンドポイントに送信し、専用のURLを取得する `uploadMedia` 関数を実装。
    2.  **投稿**: 次に、取得したメディアURLとツイート本文を、`/post` または `/schedule` エンドポイントにJSON形式で送信するように修正。
  - このアーキテクチャ変更により、パラメーターエラーは完全に解消され、投稿が成功するようになりました。

## 5. UI/UXと通知システムの改善

- **通知システムの刷新**:
  - 当初使用していた `shadcn/ui` の `Toast` コンポーネントが非推奨となったため、後継として推奨されている `sonner` ライブラリに移行しました。
  - `npx shadcn@latest add sonner` を実行してコンポーネントをプロジェクトに追加。
  - アプリケーションのルートレイアウト (`src/app/layout.tsx`) に `<Toaster />` を配置し、通知機能をグローバル化しました。
  - `TweetGenerator.tsx` 内の通知呼び出しを、すべて `sonner` の `toast.success()` や `toast.error()` 形式に統一し、よりモダンで直感的なフィードバックを提供できるように改善しました。
- **PWA対応**:
  - `next-pwa`を導入し、`next.config.mjs`と`public/manifest.json`を設定。スマートフォンやデスクトップにインストール可能なPWAとして動作するようにしました。
- **日本語化対応**:
  - UI全体のテキスト、メタデータ、フォント（`Noto_Sans_JP`）を日本語に最適化しました。

## 6. Ayrshare APIの制約判明と仕様変更

- **根本原因の特定**:
  - ユーザーによる最終テスト中に、Ayrshare APIから断続的に`403 Forbidden`エラーが返される問題が発覚。
  - エラーメッセージ (`A Premium or Business Plan is required to access this resource.`) を詳細に分析した結果、これまでの数々のAPIエラーの根本原因が、コードのバグではなく、**利用中のAyrshareの無料プランではAPI経由での画像アップロードが許可されていなかった**ことであると断定しました。
- **半自動投稿への仕様変更**:
  - この制約を受け、ユーザーはAyrshareの有料プランへの加入を見送り、アプリケーションの仕様を**完全自動投稿**から**半自動投稿**へ変更することを決定しました。
- **新仕様**:
  - Ayrshare関連の機能をすべて削除。
  - 「Xに投稿する」ボタンを押すと、以下の動作をワンクリックで実行する。
    1.  ツイート本文をクリップボードにコピー。
    2.  生成画像をローカルにダウンロード。
    3.  Xの投稿画面を新しいタブで開く。（ユーザーは手動で画像を添付し、ペーストして投稿）

## 7. 半自動投稿機能への改修

- **Ayrshare関連コードの完全削除**:
  - 不要になったAyrshareのAPIクライアント (`src/lib/ayrshare.ts`)、APIルート (`src/app/api/ayrshare`)、型定義 (`src/types/ayrshare.ts`) をプロジェクトから完全に削除しました。
- **状態管理ストアのクリーンアップ (`apiKeysStore.ts`)**:
  - `ayrshareApiKey`と投稿数制限のための`postHistory`に関連するすべての状態とロジックをZustandストアから削除し、Gemini APIキーの管理のみに特化させました。
- **UIコンポーネントの刷新**:
  - **`ApiKeySettings.tsx`**: Ayrshare APIキーの入力フィールドを削除し、UIと説明文をGemini専用に更新しました。
  - **`TweetGenerator.tsx`**:
    - 即時投稿・予約投稿ボタン、および関連するダイアログをすべて削除しました。
    - 新たに「Xに投稿する」ボタンを設置し、前述の半自動投稿フロー（クリップボードコピー、画像ダウンロード、Xの投稿画面を開く）を実行する`handlePostToX`関数を実装しました。
    - UI全体の文言やレイアウトを、新しい「生成 → 確認 → 投稿」の2ステップのワークフローに合わせて調整し、ユーザー体験を向上させました。

## 8. 現在の状況

- 新仕様に基づくすべての改修作業が完了しました。
- アプリケーションは現在、キーワードからツイート本文と画像を生成し、ユーザーが手動でXに投稿するための支援を行う半自動ツールとして動作します。
- これで、当初の目標であった「Xへの投稿を効率化するPWA」のコア機能が完成しました。

## 9. 最終調整と完成

- **機能改善**:
  - ユーザーからのフィードバックに基づき、「Xに投稿する」ボタンの動作を改善。Xの投稿画面を開く際に、ツイート本文が自動的に入力されるように `handlePostToX` 関数を修正しました。これにより、ユーザーは手動でペーストする手間が省かれ、利便性が向上しました。
- **バグ修正**:
  - Ayrshare関連コード削除後のテストで、APIキーを保存しても画面が遷移しない不具合を発見しました。
  - 原因は `src/app/page.tsx` の画面遷移ロジックに、削除済みの `ayrshareApiKey` のチェックが残っていたためでした。この不要なチェックを削除し、`geminiApiKey` の有無のみで正しく画面遷移するように修正しました。
- **リブランディング**:
  - アプリケーションの最終的な仕様に合わせて、タイトルと説明文を更新しました。
    - **旧名称**: `TweetMaster-Gemini × Ayrshare`
    - **新名称**: `Flash Tweet`
  - メインページ (`page.tsx`) とサイト全体のメタデータ (`layout.tsx`) の両方を修正し、ユーザーに表示されるすべての名称を統一しました。

これにて、すべての開発工程が完了しました。